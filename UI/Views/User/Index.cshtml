@{
    Layout = "~/Views/Shared/_Layout.content.cshtml";
    var btnlist = this.ViewData["PageBtnList"] != null ? this.ViewData["PageBtnList"] as List<Model.PageButtonModel> : new List<Model.PageButtonModel>();
}

<div class="row">
    <div class='col-xs-12'>
        <h3 class="header smaller lighter blue">用户管理</h3>
        <div id='sample-table-2_filter' class='dataTables_filter'>
            <label>
                用户名:
                <input aria-controls='sample-table-2' id="username" type='text'>
            </label>
            @Html.Partial("_View.Button/_View.Button.search")
            @if (btnlist.Exists(p => p.Code.Contains("add")))
            {
                @Html.Partial("_View.Button/_View.Button.add")
            }

        </div>
        @Html.Partial("Modal.Add")
        @Html.Partial("Modal.Edit")

        <div class="col-xs-12">
            <h3 class="header smaller lighter blue">用户列表</h3>

            <div class="clearfix">
                <div class="pull-right tableTools-container"></div>
            </div>

            <div class="table-header">
                结果
            </div>

            <!-- div.table-responsive -->
            <!-- div.dataTables_borderWrap -->
            <div>
                <table id="dynamic-table" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th class="center">
                                <label class="pos-rel">
                                    <input type="checkbox" class="ace" />
                                    <span class="lbl"></span>
                                </label>
                            </th>
                            <th>用户名</th>
                            <th>姓名</th>
                            <!--<th class="hidden-480">电话</th>
                            <th>QQ</th>
                            <th class="hidden-480">微信</th>
                            <th class="hidden-480">邮箱</th>-->
                            <th class="hidden-480">状态</th>
                            <th class="hidden-480">
                                <i class="ace-icon fa fa-clock-o bigger-110 hidden-480"></i>创建时间
                            </th>
                            <th>操作（ 编辑/ 删除/ 设置角色/ 设置用户）</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>

    @section scripts {
        <!-- page specific plugin scripts -->
        <script src="~/assets/js/jquery.dataTables.min.js"></script>
        <script src="~/assets/js/jquery.dataTables.bootstrap.min.js"></script>
        <script src="~/assets/js/dataTables.buttons.min.js"></script>
        <script src="~/assets/js/buttons.flash.min.js"></script>
        <script src="~/assets/js/buttons.html5.min.js"></script>
        <script src="~/assets/js/buttons.print.min.js"></script>
        <script src="~/assets/js/buttons.colVis.min.js"></script>
        <script src="~/assets/js/dataTables.select.min.js"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script type="text/javascript">
            jQuery(function ($) {

                //initiate dataTables plugin
                var myTable =
                $('#dynamic-table')
                    .on('draw.dt', function () {
                        $("a[data-type='operation']").each(function () {
                            var id = $(this).parents("tr").find("td").eq(0).find("input").attr("data-id");

                            //详情
                            if ($(this).attr("data-title") == "View") {
                                $(this).on("click", function () {

                                });
                            }
                                //删除
                            else if ($(this).attr("data-title") == "Delete") {
                                $(this).on("click", function () {

                                    //swal提示
                                    swal({
                                        title: "提示！",
                                        text: "确认删除？",
                                        icon: "warning",
                                        dangerMode: true,
                                        buttons: ["取消", "确定"]
                                    }).then(function (willDelete) {

                                        //确认删除
                                        if (willDelete) {
                                            var data = {};
                                            data["id"] = id;
                                            $.ajax({
                                                type: 'post',//可选get
                                                url: "../User/Delet",
                                                data: JSON.stringify(data),
                                                contentType: "application/json", //必须有
                                                dataType: 'json',//服务器返回的数据类型 可选XML ,Json jsonp script htmltext等
                                                success: function (result) {
                                                    if (result.success) {
                                                        swal("删除成功!", {
                                                            icon: "success",
                                                        });
                                                        myTable.draw();
                                                    }
                                                    else {
                                                        swal("删除失败!"+result.msg+"", {
                                                            icon: "error",
                                                        });
                                                    }
                                                },
                                                error: function () {
                                                    swal("删除失败!", {
                                                        icon: "error",
                                                    });
                                                }
                                            });

                                        }
                                        else {
                                            swal("删除已取消！", {
                                                icon: "success",
                                            });
                                        }

                                    });
                                });
                            }
                                //编辑
                            else if ($(this).attr("data-title") == "Edit") {
                                $(this).on("click", function () {
                                    var data = {};
                                    data["id"] = id;
                                    $.ajax({
                                        type: 'post',//可选get
                                        url: "../User/GetUser",
                                        data: JSON.stringify(data),
                                        contentType: "application/json", //必须有
                                        dataType: 'json',//服务器返回的数据类型 可选XML ,Json jsonp script htmltext等
                                        success: function (result) {
                                            $("#my-modal-edit").find("input[name='txtuserid']").val(result.UserID);
                                            $("#my-modal-edit").find("input[name='txtusername']").val(result.UserName);
                                            $("#my-modal-edit").find("input[name='txtpwd']").val(result.UserPassword);
                                            $("#my-modal-edit").find("input[name='txtname']").val(result.RealName);
                                            $("#my-modal-edit").find("input[name='gender']").each(function () {
                                                if ($(this).val() == $.trim(result.Sex)) {
                                                    $(this).prop("checked", 'checked');                                                    
                                                } 
                                            });
                                            $("#my-modal-edit").find("input[name='txtemail']").val(result.E_mail);
                                            $("#my-modal-edit").find("input[name='txtphone']").val(result.Phone);
                                            $("#my-modal-edit").find("input[name='txtqq']").val(result.QQ);
                                            $("#my-modal-edit").find("input[name='txtwechat']").val(result.Wechat);                                           
                                        },
                                        error: function () {
                                            swal("获取用户信息失败!", {
                                                icon: "error",
                                            });
                                        }
                                    });
                                });
                            }
                        });
                    }) //表格绘制完成
            //.wrap("<div class='dataTables_borderWrap' />")   //if you are applying horizontal scrolling (sScrollX)
                .DataTable({
                    bAutoWidth: false,//表格宽度自适应
                    processing: true, //等待加载效果
                    ajax: {
                        url: '../User/Search',
                        type: 'POST',
                        dataType: 'json',

                        //添加额外的参数传给服务器
                        data: function (d) {
                            d.username = $("#username").val();//用户名
                        }
                    },
                    columns: [
                        {
                            "data": "UserID",
                            "sClass": "center",//显示样式
                            "render": function (data, type, row, meta) {
                                return ' <label class="pos-rel"><input type="checkbox" class="ace" data-id=' + data + ' /><span class="lbl"></span></label>';
                            }
                        },
                        {
                            "data": "UserName",
                            "render": function (data, type, row, meta) {
                                return '<a href="#">' + data + '</a>';
                            }
                        },
                        {
                            "data": "RealName"
                        },
                        //{
                        //    "data": "Phone"
                        //},
                        //{
                        //    "data": "QQ"
                        //},
                        //{
                        //    "data": "Wechat"
                        //},
                        //{
                        //    "data": "E-mail"
                        //},
                        {
                            "data": "State",
                            "render": function (data, type, row, meta) {
                                if (data == "0") {
                                    return '<span class="label label-sm label-warning">未授权</span>';
                                } else if (data == "1") {
                                    return '<span class="label label-sm label-success">启用</span>';
                                } else if (data == "2") {
                                    return '<span class="label label-sm label-inverse arrowed-in">锁定</span>';
                                }
                            }
                        },
                        {
                            "data": "CreateDate",
                            "render": function (data, type, row, meta) {
                                return new Date(data)//处理时间显示
                                                     .toLocaleString();
                            }

                        },
                        {
                            "defaultContent": "",
                            "render": function (data, type, row, meta) {
                                return $("#operation").html();
                            }
                        }
                    ],
                    serverSide: true,  //开启服务器模式
                    searching: false,  //禁用搜索
                    ordering: false,   //禁用排序
                    "iDisplayLength": 15, //每页默认显示数据条数
                    "aLengthMenu": [
                      [5, 15, 20, 50],
                      [5, 15, 20, 50]
                    ],
                    language: {
                        url: '../assets/lang/jQuery.Datatable.lang.Chinese.json'
                    }, //翻译成中文

                    select: {
                        style: 'multi'
                    }
                });

                //查询-搜索
                $("#searchBtn").on("click", function () {
                    myTable.draw();
                });

                //新增-保存
                $("#btnAddSave").on("click", function () {
                    var data = {
                        "UserName": $.trim($("#my-modal-add").find("input[name='txtusername']").val()),
                        "UserPassword": $.trim($("#my-modal-add").find("input[name='txtpwd']").val()),
                        "RealName": $.trim($("#my-modal-add").find("input[name='txtname']").val()),
                        "Sex": $.trim($("#my-modal-add").find("input[name='gender']:checked").val()),
                        "E_mail": $.trim($("#my-modal-add").find("input[name='txtemail']").val()),
                        "Phone": $.trim($("#my-modal-add").find("input[name='txtphone']").val()),
                        "QQ": $.trim($("#my-modal-add").find("input[name='txtqq']").val()),
                        "Wechat": $.trim($("#my-modal-add").find("input[name='txtwechat']").val())
                    };
                    $.ajax({
                        type: 'post',//可选get
                        url: "../User/Add",
                        data: JSON.stringify(data),
                        contentType: "application/json", //必须有
                        dataType: 'json',//服务器返回的数据类型 可选XML ,Json jsonp script htmltext等
                        success: function (result) {
                            if (result.success) {
                                swal("保存成功!", {
                                    icon: "success",
                                });
                                $('#form-add')[0].reset();
                                myTable.draw();
                            }
                            else {
                                swal("保存失败!" + result.msg + "", {
                                    icon: "error",
                                });
                            }
                        },
                        error: function () {
                            swal("保存失败!" + result.msg + "", {
                                icon: "success",
                            });
                        }
                    });
                });

                //编辑-保存
                $("#btnEditSave").on("click", function () {
                    var data = {
                        "UserID": $.trim($("#my-modal-edit").find("input[name='txtuserid']").val()),
                        "UserName": $.trim($("#my-modal-edit").find("input[name='txtusername']").val()),
                        "UserPassword": $.trim($("#my-modal-edit").find("input[name='txtpwd']").val()),
                        "RealName": $.trim($("#my-modal-edit").find("input[name='txtname']").val()),
                        "Sex": $.trim($("#my-modal-edit").find("input[name='gender']:checked").val()),
                        "E_mail": $.trim($("#my-modal-edit").find("input[name='txtemail']").val()),
                        "Phone": $.trim($("#my-modal-edit").find("input[name='txtphone']").val()),
                        "QQ": $.trim($("#my-modal-edit").find("input[name='txtqq']").val()),
                        "Wechat": $.trim($("#my-modal-edit").find("input[name='txtwechat']").val())
                    };
                    $.ajax({
                        type: 'post',//可选get
                        url: "../User/Edit",
                        data: JSON.stringify(data),
                        contentType: "application/json", //必须有
                        dataType: 'json',//服务器返回的数据类型 可选XML ,Json jsonp script htmltext等
                        success: function (result) {
                            if (result.success) {
                                swal("保存成功!", {
                                    icon: "success",
                                });
                                $('#form-add')[0].reset();
                                myTable.draw();
                            }
                            else {
                                swal("保存失败!" + result.msg + "", {
                                    icon: "error",
                                });
                            }
                        },
                        error: function () {
                            swal("保存失败!" + result.msg + "", {
                                icon: "success",
                            });
                        }
                    });
                });



                $.fn.dataTable.Buttons.defaults.dom.container.className = 'dt-buttons btn-overlap btn-group btn-overlap';

                new $.fn.dataTable.Buttons(myTable, {
                    buttons: [
                      {
                          "extend": "colvis",
                          "text": "<i class='fa fa-search bigger-110 blue'></i> <span class='hidden'>显示/隐藏 列</span>",
                          "className": "btn btn-white btn-primary btn-bold",
                          columns: ':not(:first):not(:last)'
                      },
                      {
                          "extend": "copy",
                          "text": "<i class='fa fa-copy bigger-110 pink'></i> <span class='hidden'>复制到剪切板</span>",
                          "className": "btn btn-white btn-primary btn-bold"
                      },
                      {
                          "extend": "csv",
                          "text": "<i class='fa fa-database bigger-110 orange'></i> <span class='hidden'>导出CSV</span>",
                          "className": "btn btn-white btn-primary btn-bold"
                      },
                      {
                          "extend": "excel",
                          "text": "<i class='fa fa-file-excel-o bigger-110 green'></i> <span class='hidden'>导出Excel</span>",
                          "className": "btn btn-white btn-primary btn-bold"
                      },
                      {
                          "extend": "pdf",
                          "text": "<i class='fa fa-file-pdf-o bigger-110 red'></i> <span class='hidden'>导出PDF</span>",
                          "className": "btn btn-white btn-primary btn-bold"
                      },
                      {
                          "extend": "print",
                          "text": "<i class='fa fa-print bigger-110 grey'></i> <span class='hidden'>打印</span>",
                          "className": "btn btn-white btn-primary btn-bold",
                          autoPrint: false,
                          message: 'This print was produced using the Print button for DataTables'
                      }
                    ]
                });
                myTable.buttons().container().appendTo($('.tableTools-container'));

                //style the message box
                var defaultCopyAction = myTable.button(1).action();
                myTable.button(1).action(function (e, dt, button, config) {
                    defaultCopyAction(e, dt, button, config);
                    $('.dt-button-info').addClass('gritter-item-wrapper gritter-info gritter-center white');
                });


                var defaultColvisAction = myTable.button(0).action();
                myTable.button(0).action(function (e, dt, button, config) {

                    defaultColvisAction(e, dt, button, config);


                    if ($('.dt-button-collection > .dropdown-menu').length == 0) {
                        $('.dt-button-collection')
                        .wrapInner('<ul class="dropdown-menu dropdown-light dropdown-caret dropdown-caret" />')
                        .find('a').attr('href', '#').wrap("<li />")
                    }
                    $('.dt-button-collection').appendTo('.tableTools-container .dt-buttons')
                });

                ////

                setTimeout(function () {
                    $($('.tableTools-container')).find('a.dt-button').each(function () {
                        var div = $(this).find(' > div').first();
                        if (div.length == 1) div.tooltip({ container: 'body', title: div.parent().text() });
                        else $(this).tooltip({ container: 'body', title: $(this).text() });
                    });
                }, 500);

                myTable.on('select', function (e, dt, type, index) {
                    if (type === 'row') {
                        $(myTable.row(index).node()).find('input:checkbox').prop('checked', true);
                    }
                });

                myTable.on('deselect', function (e, dt, type, index) {
                    if (type === 'row') {
                        $(myTable.row(index).node()).find('input:checkbox').prop('checked', false);
                    }
                });

                /////////////////////////////////
                //table checkboxes
                $('th input[type=checkbox], td input[type=checkbox]').prop('checked', false);

                //select/deselect all rows according to table header checkbox
                $('#dynamic-table > thead > tr > th input[type=checkbox], #dynamic-table_wrapper input[type=checkbox]').eq(0).on('click', function () {
                    var th_checked = this.checked;//checkbox inside "TH" table header

                    $('#dynamic-table').find('tbody > tr').each(function () {
                        var row = this;
                        if (th_checked) myTable.row(row).select();
                        else myTable.row(row).deselect();
                    });
                });

                //select/deselect a row when the checkbox is checked/unchecked
                $('#dynamic-table').on('click', 'td input[type=checkbox]', function () {
                    var row = $(this).closest('tr').get(0);
                    if (this.checked) myTable.row(row).deselect();
                    else myTable.row(row).select();
                });

                $(document).on('click', '#dynamic-table .dropdown-toggle', function (e) {
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    e.preventDefault();
                });

                //And for the first simple table, which doesn't have TableTools or dataTables
                //select/deselect all rows according to table header checkbox
                var active_class = 'active';
                $('#simple-table > thead > tr > th input[type=checkbox]').eq(0).on('click', function () {
                    var th_checked = this.checked;//checkbox inside "TH" table header

                    $(this).closest('table').find('tbody > tr').each(function () {
                        var row = this;
                        if (th_checked) $(row).addClass(active_class).find('input[type=checkbox]').eq(0).prop('checked', true);
                        else $(row).removeClass(active_class).find('input[type=checkbox]').eq(0).prop('checked', false);
                    });
                });

                //select/deselect a row when the checkbox is checked/unchecked
                $('#simple-table').on('click', 'td input[type=checkbox]', function () {
                    var $row = $(this).closest('tr');
                    if ($row.is('.detail-row ')) return;
                    if (this.checked) $row.addClass(active_class);
                    else $row.removeClass(active_class);
                });


                /********************************/
                //add tooltip for small view action buttons in dropdown menu
                $('[data-rel="tooltip"]').tooltip({ placement: tooltip_placement });

                //tooltip placement on right or left
                function tooltip_placement(context, source) {
                    var $source = $(source);
                    var $parent = $source.closest('table')
                    var off1 = $parent.offset();
                    var w1 = $parent.width();

                    var off2 = $source.offset();
                    //var w2 = $source.width();

                    if (parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2)) return 'right';
                    return 'left';
                }


                /***************/
                $('.show-details-btn').on('click', function (e) {
                    e.preventDefault();
                    $(this).closest('tr').next().toggleClass('open');
                    $(this).find(ace.vars['.icon']).toggleClass('fa-angle-double-down').toggleClass('fa-angle-double-up');
                });
                /***************/


                /**
                //add horizontal scrollbars to a simple table
                $('#simple-table').css({'width':'2000px', 'max-width': 'none'}).wrap('<div style="width: 1000px;" />').parent().ace_scroll(
                  {
                    horizontal: true,
                    styleClass: 'scroll-top scroll-dark scroll-visible',//show the scrollbars on top(default is bottom)
                    size: 2000,
                    mouseWheelLock: true
                  }
                ).css('padding-top', '12px');
                */


            })
        </script>
    }

    <!--操作按钮-->
    <script type="text/html" id="operation">
        <div class="hidden-sm hidden-xs action-buttons">
            @if (btnlist.Exists(p => p.Code.Contains("edit")))
            {
                @Html.Partial("_View.Button/_View.Button.md.Edit")
            }
            @if (btnlist.Exists(p => p.Code.Contains("delete")))
            {
                @Html.Partial("_View.Button/_View.Button.md.Delete")
            }
            @if (btnlist.Exists(p => p.Code.Contains("setrole")))
            {
                @Html.Partial("_View.Button/_View.Button.md.setrole")
            }
        </div>

        <div class="hidden-md hidden-lg">
            <div class="inline pos-rel">
                <button class="btn btn-minier btn-yellow dropdown-toggle" data-toggle="dropdown" data-position="auto">
                    <i class="ace-icon fa fa-caret-down icon-only bigger-120"></i>
                </button>

                <ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">       
                    @if (btnlist.Exists(p => p.Code.Contains("edit")))
                    {
                        @Html.Partial("_View.Button/_View.Button.sm.Edit")
                    }
                    @if (btnlist.Exists(p => p.Code.Contains("delete")))
                    {
                        @Html.Partial("_View.Button/_View.Button.sm.Delete")
                    }
                    @if (btnlist.Exists(p => p.Code.Contains("setrole")))
                    {
                        @Html.Partial("_View.Button/_View.Button.sm.setrole")
                    }
                </ul>
            </div>
        </div>
    </script>
